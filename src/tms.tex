\chapter*{タイルマップサービス(TMS)とは}

GoogleMapsのように、表示する位置や縮尺を自由に変えられる地図をslippy mapといいます。
日本語では「スクロール地図」でしょうか。
さて、このslippy mapを作って欲しいと依頼された時、あなたはどのように実装しますか？

まず地図の情報が必要です。それは画像である必要があります。
その画像を切り出してブラウザに表示する...ざっくりそんな感じになるでしょうか。
まさにこれを実装したのが、タイルマップサービス(Tile Map Service) TMSと
よばれるものです。
%
TMSは、正確に言うと Open Source Geospatial Fundation (OSGeo財団)によって開発された
タイルの仕様で、オープンソースなプロダクトによく使われています。
同様の機能を実現した、WMTS (Web Map Tile Service)というものもあります。

\section*{タイル}
一枚の大きな世界地図を、小片に分割して必要なものだけ送ることで、ネットワークの帯域やメモリの消費を抑えることができます。
この分割された地図の小片を「タイル」と呼びます。
TMSでは、タイルは一辺が256ピクセルの正方形のPNG画像です。
次にタイルの切り出し方を考えます。
まず、世界地図を1枚のタイルで表現することができます。この縮尺をズームレベル0と呼びます。
ズームレベルは、正の整数値で、1増える毎に表示する面積が1/4になります。
すなわち、ズームレベル1では、縦2枚、横2枚の4枚のタイルで全世界を表現します。
同様にズームレベル2では、16枚になります。
これを繰り返していくと、図\ref{fig:tile_pylamid}のようなピラミッド構造になります。

\begin{figure}[thbp]
\centering
\includegraphics{Tiling.eps}
\caption{タイルのピラミッド構造[1]}
\label{fig:tile_pylamid}
\end{figure}

このタイルの位置は、x、yの座標で、OpenStreetMapでは、緯度経度との関係は以下の通りです[2]。
\[
x = \frac{2^z(lon+180)}{360}
\]
\[
y = 2^{z-1}(1-\frac{\ln(\tan(\frac{lat\pi}{180})+\sec(\frac{lat\pi}{180}))}{\pi})
\]
ここで、$lon$、$lat$は、それぞれ度単位の経度、緯度、$z$はズームレベルです。
ちなみにxyの原点は...って聞かれると、
TMSは左下で、WMTSは右上で、OpenStreetMapは、Y flipped TMSとやらで、左上だったり、
結構闇だったりします。上の式はOpenStreetMapのものなので、TMSとは異なるので注意が必要です。

\section*{タイルの配布}
さて、タイルのことはわかってきました。それでは、どのようにタイルを取得するすれば良いのでしょう。
TMSはブラウザに地図を表示するためのものですので、もちろんWebサーバからHTTPで取得します。
URLは、以下のようになります。
\begin{center}
  \texttt{http://tms.example.org/1.0.0/name/z/x/y.png}
\end{center}

x、yはタイルの座標で、zはズームレベル、1.0.0というのはTMSのバージョンです。
nameはタイルの名前です。
例えば、地理院地図の50万分の1のタイルのURLは
\begin{center}
  \texttt{http://cyberjapandata.gsi.go.jp/xyz/std/z/x/y.png}
\end{center}
となります。
実際のタイルサーバでは、TMSのバージョンがなかったり、結構自由です。
正確には地理院地図はTMSと名乗っていません。
ただ、TMSもWMTSも地理院地図もOpenStreetMapも、URLでXYZを指定してタイルを取得するので
これらを総称してXYZタイルやXYZレイヤなどと呼ばれています。
仕様はがっちり決められていても、実装が追いつかないのはよくある話ですね。

この本でも、がっちりTMSを実装するのではなく、ざっくりXYZタイルサービスを作成することにしましょう。

それでは、タイルサーバを作っていきましょう。
次章では、まずOpenStreetMapや地理院地図に重ねる
海水面温度のデータを可視化し、地理情報を持ったGeoTiff形式の
画像を作成します。
